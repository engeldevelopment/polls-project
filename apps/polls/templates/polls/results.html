{% extends 'base.html' %}

{% load static %}

{% block title %} {{ block.super }} | Resultados de {{ question.text }} {% endblock %}

{% block content %}
<div class="row" id="app">
  <div class="col s12 l10 offset-l1">
    <article class="card">
      <div class="card-content">
        {% if errors %}
        <div>
          {% for error in errors %}
            <p class="red-text flow-text" data-error="error">{{ error }}</p>
          {% endfor %}
        </div>
        {% else %}
        <h2 class="card-title pink-text">
          {{ question.text }}
        </h2>
        <ul class="collection with-header">
          <li class="collection-header">
            <h4>Resultados</h4>
          </li>
          {% for choice in choices %}
          <li class="collection-item">{{ choice.text }}
            <span class="new badge pink" data-badge-caption="">
              <strong>{{ choice.votes }}</strong>
            </span>
          </li>
          {% endfor %}
        </ul>
        <div class="card-content">
          <canvas height="300" width="200" id="result"></canvas>
        </div>
        {% endif %}
      </div>
      <div class="card-action">
        <a href="{% url 'polls:index' %}" class="btn grey darken-3">
          Regresar <i class="material-icons right">arrow_back</i>
        </a>
      </div>
    </article>
  </div>
</div>
{% endblock %}

{% block js %}
<script src="{% static 'js/vue.min.js' %}"></script>
<script src="{% static 'js/axios.min.js' %}"></script>
<script type="text/javascript">
new Vue({
  el: "#app",
  delimiters: ['${', '}'],
  data: {
    hasError: false
  },
  methods: {
    getResults() {
      const END_POINT = '/api/v1/question/{{question.pk}}/results';
      const self = this;

      axios.get(END_POINT)
        .then(response => {
          self.showResults(response);
        })
    },
    showResults(response) {
      this.handlerError(response.status)
      if (!this.hasError) {
        this.makeGraphic(response.data)
      }
    },
    handlerError(statusCode) {
      const NO_CONTENT = 204;

      switch (statusCode) {
        case NO_CONTENT: this.hasError = true;
          break;
      }
    },
    makeGraphic(result) {
      var context = document.getElementById('result').getContext('2d');

      const {labels, data} = this.makeDataForGraphic(result);  

      new Chart(context, {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [
            {
              label: '# votos',
              data: data,
              backgroundColor: [
                'rgba(255, 99, 132, 0.2)',
                'rgba(255, 206, 86, 0.2)'
              ]
            }
          ]
        }
      });
    },
    makeDataForGraphic(result) {
      let labels = [];
      let data = [];
      for (choice of result.choices) {
        labels.push(choice.text);
        data.push(choice.votes);
      }
      return { labels, data }
    }
  },
  created() {
    this.getResults()
  }
}) 
</script>
{% endblock %}